<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>ExpenseFlow</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Sans:wght@300;400;500;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0e0f11;--surface:#16181c;--surface2:#1e2128;--border:#2a2d35;--accent:#e8c97a;--accent2:#6ee7b7;--accent3:#f87a6b;--text:#f0ede6;--muted:#8a8d96;--r:12px;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);background-image:radial-gradient(ellipse at 20% 0%,rgba(232,201,122,.07) 0%,transparent 50%),radial-gradient(ellipse at 80% 100%,rgba(110,231,183,.04) 0%,transparent 50%);}
.shell{display:flex;flex-direction:column;height:100%;max-width:540px;margin:0 auto;}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:16px 18px 10px;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;padding-top:calc(16px + env(safe-area-inset-top,0px));}
.topbar-logo{font-family:'DM Serif Display',serif;font-size:18px;color:var(--accent);}
.topbar-entity{display:flex;gap:6px;}
.ent-pill{padding:5px 11px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;border:1px solid var(--border);color:var(--muted);background:var(--surface2);transition:all .15s;}
.ep-all{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.15);color:var(--text);}
.ep-orin{background:rgba(232,201,122,.12);border-color:rgba(232,201,122,.4);color:var(--accent);}
.ep-aasha{background:rgba(110,231,183,.12);border-color:rgba(110,231,183,.4);color:var(--accent2);}
.content{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:16px 16px 100px;}
.fab{position:fixed;bottom:calc(64px + env(safe-area-inset-bottom,0px) + 14px);right:20px;width:52px;height:52px;border-radius:50%;background:var(--accent);color:#0e0f11;border:none;font-size:28px;line-height:1;cursor:pointer;box-shadow:0 4px 20px rgba(232,201,122,.4);display:flex;align-items:center;justify-content:center;transition:all .15s;z-index:40;}
.fab:active{transform:scale(.92);}
.bottom-nav{display:flex;background:var(--surface);border-top:1px solid var(--border);flex-shrink:0;padding-bottom:calc(6px + env(safe-area-inset-bottom,0px));}
.bnav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:10px 0 6px;border:none;background:transparent;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:10px;font-weight:500;cursor:pointer;transition:color .15s;}
.bnav-btn .bi{font-size:20px;line-height:1;}
.bnav-btn.active{color:var(--accent);}
.page{display:none;animation:fadeIn .15s ease;}
.page.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.sec-title{font-family:'DM Serif Display',serif;font-size:22px;margin-bottom:2px;}
.sec-sub{font-size:12px;color:var(--muted);margin-bottom:16px;}
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
.stat{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:14px 16px;}
.stat .lbl{font-size:10px;letter-spacing:.8px;text-transform:uppercase;color:var(--muted);margin-bottom:5px;}
.stat .val{font-family:'Space Mono',monospace;font-size:17px;font-weight:700;}
.stat .sub{font-size:11px;color:var(--muted);margin-top:3px;}
.yellow{color:var(--accent);}.green{color:var(--accent2);}.red{color:var(--accent3);}
.chart-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:12px;}
.chart-card h4{font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);font-weight:600;font-family:'Space Mono',monospace;margin-bottom:14px;}
.bar-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.bar-lbl{font-size:11px;color:var(--muted);width:100px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex-shrink:0;}
.bar-track{flex:1;height:7px;background:var(--surface2);border-radius:4px;overflow:hidden;}
.bar-fill{height:100%;border-radius:4px;transition:width .5s ease;}
.bar-val{font-family:'Space Mono',monospace;font-size:10px;color:var(--muted);width:70px;text-align:right;flex-shrink:0;}
.expense-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:14px;margin-bottom:10px;}
.exp-top{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;}
.exp-serial{font-family:'Space Mono',monospace;font-size:10px;color:var(--accent);background:rgba(232,201,122,.08);padding:2px 7px;border-radius:4px;flex-shrink:0;}
.exp-amount{font-family:'Space Mono',monospace;font-size:16px;font-weight:700;white-space:nowrap;}
.exp-desc{font-size:14px;font-weight:500;margin:6px 0 4px;line-height:1.3;}
.exp-meta{display:flex;flex-wrap:wrap;gap:5px;align-items:center;margin-top:6px;}
.badge{display:inline-flex;align-items:center;padding:2px 9px;border-radius:20px;font-size:10px;font-weight:500;}
.bt{background:rgba(232,201,122,.12);color:var(--accent);}.bm{background:rgba(248,122,107,.12);color:var(--accent3);}.bo{background:rgba(110,231,183,.12);color:var(--accent2);}.bs{background:rgba(167,139,250,.12);color:#a78bfa;}.br{background:rgba(56,189,248,.12);color:#38bdf8;}
.etag{font-size:10px;padding:2px 7px;border-radius:4px;background:var(--surface2);border:1px solid var(--border);font-family:'Space Mono',monospace;}
.etag.orin{border-color:rgba(232,201,122,.3);color:var(--accent);background:rgba(232,201,122,.05);}
.etag.aasha{border-color:rgba(110,231,183,.3);color:var(--accent2);background:rgba(110,231,183,.05);}
.exp-date,.exp-paid{font-size:11px;color:var(--muted);}
.exp-notes{font-size:11px;color:var(--muted);margin-top:4px;font-style:italic;}
.exp-rcpt{font-size:11px;color:var(--accent2);}
.exp-actions{display:flex;gap:8px;margin-top:10px;padding-top:10px;border-top:1px solid var(--border);align-items:center;}
.act-btn{padding:8px 14px;border-radius:8px;border:1px solid var(--border);background:none;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;cursor:pointer;transition:all .15s;}
.act-btn.edit:active{border-color:var(--accent);color:var(--accent);}
.act-btn.del:active{border-color:var(--accent3);color:var(--accent3);}
.synced-badge{font-size:10px;margin-left:auto;color:var(--muted);}
.empty-state{text-align:center;padding:48px 24px;color:var(--muted);}
.empty-state .ei{font-size:36px;margin-bottom:12px;}
.filter-bar{display:flex;gap:8px;margin-bottom:14px;overflow-x:auto;padding-bottom:2px;}
.filter-bar::-webkit-scrollbar{display:none;}
.fsel{background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:12px;padding:7px 10px;outline:none;cursor:pointer;flex-shrink:0;-webkit-appearance:none;}
.setup-block{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:18px;margin-bottom:12px;}
.setup-block h3{font-family:'DM Serif Display',serif;font-size:18px;margin-bottom:6px;}
.setup-block .sp{font-size:13px;color:var(--muted);margin-bottom:16px;line-height:1.6;}
.step-row{display:flex;gap:10px;margin-bottom:10px;font-size:13px;}
.step-num{width:22px;height:22px;border-radius:50%;background:var(--accent);color:#0e0f11;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;}
.step-txt{color:var(--muted);line-height:1.5;}.step-txt strong{color:var(--text);}
.drive-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.dlbl{font-size:12px;font-weight:600;width:90px;flex-shrink:0;}
.dlbl.orin{color:var(--accent);}.dlbl.aasha{color:var(--accent2);}
.conn-bar{display:flex;align-items:center;gap:8px;padding:9px 13px;border-radius:8px;background:rgba(110,231,183,.08);border:1px solid rgba(110,231,183,.2);color:var(--accent2);font-size:13px;margin-top:12px;}
.pulse{width:7px;height:7px;border-radius:50%;background:var(--accent2);animation:blink 2s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.exp-btns{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.72);z-index:200;align-items:flex-end;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border-radius:20px 20px 0 0;border-top:1px solid var(--border);width:100%;max-width:540px;max-height:92vh;overflow-y:auto;-webkit-overflow-scrolling:touch;animation:sUp .25s ease;padding:20px 20px calc(20px + env(safe-area-inset-bottom,0px));}
@keyframes sUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:36px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 18px;}
.modal-title{font-family:'DM Serif Display',serif;font-size:20px;margin-bottom:4px;}
.mserial{font-family:'Space Mono',monospace;font-size:11px;color:var(--accent);background:rgba(232,201,122,.08);padding:3px 9px;border-radius:4px;display:inline-block;margin-bottom:18px;}
.form2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.fg{margin-bottom:13px;position:relative;}
.fg label{font-size:11px;color:var(--muted);letter-spacing:.4px;display:block;margin-bottom:5px;font-weight:500;}
.fg input,.fg select,.fg textarea{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:9px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:15px;padding:11px 13px;outline:none;transition:border-color .15s;-webkit-appearance:none;appearance:none;}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--accent);}
.fg textarea{resize:none;min-height:62px;}
.fg select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%238a8d96' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 13px center;padding-right:36px;}
.paid-opts{position:absolute;top:calc(100% + 4px);left:0;right:0;background:var(--surface2);border:1px solid var(--border);border-radius:9px;z-index:300;box-shadow:0 8px 28px rgba(0,0,0,.5);display:none;max-height:150px;overflow-y:auto;}
.paid-opt{padding:10px 13px;font-size:14px;cursor:pointer;color:var(--text);}
.paid-opt:active{background:var(--border);}
.upload-zone{border:2px dashed var(--border);border-radius:var(--r);padding:18px;text-align:center;cursor:pointer;transition:all .2s;background:var(--surface2);}
.upload-zone.dragover{border-color:var(--accent);}
.upload-zone .ui{font-size:22px;margin-bottom:5px;}
.upload-zone p{font-size:12px;color:var(--muted);}
.upload-zone input{display:none;}
.uprev{margin-top:7px;font-size:12px;color:var(--accent2);}
.drive-note{font-size:11px;color:var(--muted);margin-top:5px;font-style:italic;}
.mact{display:flex;gap:10px;margin-top:18px;}
.btn-p{flex:1;padding:13px;background:var(--accent);color:#0e0f11;border:none;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:700;cursor:pointer;transition:all .15s;}
.btn-p:active{transform:scale(.97);}
.btn-g{padding:13px 18px;background:none;border:1px solid var(--border);border-radius:10px;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:15px;cursor:pointer;}
.btn-d{flex:1;padding:13px;background:var(--accent3);color:#fff;border:none;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:700;cursor:pointer;}
.btn-d:active{transform:scale(.97);}
.confirm-body{text-align:center;padding:4px 0;}
.confirm-body .ci{font-size:38px;margin-bottom:10px;}
.confirm-body p{font-size:14px;color:var(--muted);margin:8px 0 20px;line-height:1.5;}
.finput{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:9px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;padding:10px 12px;outline:none;}
.toast{position:fixed;bottom:calc(74px + env(safe-area-inset-bottom,0px) + 8px);left:50%;transform:translateX(-50%) translateY(20px);background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:11px 18px;font-size:13px;color:var(--text);display:flex;align-items:center;gap:8px;box-shadow:0 6px 24px rgba(0,0,0,.4);z-index:500;opacity:0;transition:all .25s ease;white-space:nowrap;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.toast.success{border-color:rgba(110,231,183,.4);}.toast.error{border-color:rgba(248,122,107,.4);}
@media(min-width:700px){
  html,body{overflow:auto;}
  .shell{flex-direction:row;max-width:100%;height:100vh;}
  .topbar{display:none;}.bottom-nav{display:none;}
  .fab{bottom:24px;right:28px;}
  .sbar{display:flex!important;flex-direction:column;width:220px;background:var(--surface);border-right:1px solid var(--border);padding:28px 18px;flex-shrink:0;overflow-y:auto;}
  .sbar-logo{font-family:'DM Serif Display',serif;font-size:18px;color:var(--accent);margin-bottom:2px;}
  .sbar-sub{font-size:11px;color:var(--muted);margin-bottom:24px;}
  .sbar-lbl{font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);font-weight:600;margin-bottom:8px;}
  .sbar-btn{display:flex;align-items:center;gap:9px;width:100%;padding:9px 11px;border-radius:8px;border:none;background:transparent;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;cursor:pointer;text-align:left;transition:all .15s;margin-bottom:2px;}
  .sbar-btn:hover{background:var(--surface2);color:var(--text);}
  .sbar-btn.active{background:rgba(232,201,122,.12);color:var(--accent);}
  .sbar-ep{display:flex;align-items:center;gap:7px;padding:8px 11px;border-radius:8px;background:var(--surface2);font-size:12px;cursor:pointer;border:1px solid transparent;transition:all .15s;margin-bottom:5px;}
  .sbar-ep.ep-all{border-color:rgba(255,255,255,.12);color:var(--text);}
  .sbar-ep.ep-orin{border-color:rgba(232,201,122,.35);color:var(--accent);}
  .sbar-ep.ep-aasha{border-color:rgba(110,231,183,.35);color:var(--accent2);}
  .edot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
  .sbar-sync{margin-top:auto;display:flex;align-items:center;gap:7px;padding:10px 13px;border-radius:var(--r);background:rgba(110,231,183,.08);border:1px solid rgba(110,231,183,.2);color:var(--accent2);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;cursor:pointer;width:100%;transition:all .2s;}
  .sbar-sync:hover{background:rgba(110,231,183,.15);}
  .content{padding:28px 32px 40px;}
  .stat-grid{grid-template-columns:repeat(4,1fr);}
  .modal-overlay{align-items:center;}
  .modal{border-radius:16px;max-width:520px;padding:28px;}
  .modal-handle{display:none;}
  .toast{bottom:24px;}
}
.sbar{display:none;}
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
</style>
</head>
<body>
<div class="shell">
  <!-- DESKTOP SIDEBAR -->
  <aside class="sbar" id="sbar">
    <div class="sbar-logo">ExpenseFlow</div>
    <div class="sbar-sub">Orin Global &amp; Aasha Setu</div>
    <div style="margin-bottom:12px">
      <div class="sbar-lbl">Navigation</div>
      <button class="sbar-btn active" id="sbn-dash"      onclick="goto('dash')">‚¨° Dashboard</button>
      <button class="sbar-btn"        id="sbn-expenses"  onclick="goto('expenses')">‚óà All Expenses</button>
      <button class="sbar-btn"        id="sbn-analytics" onclick="goto('analytics')">‚óâ Analytics</button>
      <button class="sbar-btn"        id="sbn-sheets"    onclick="goto('sheets')">‚¨¢ Sheets &amp; Drive</button>
    </div>
    <div style="margin-bottom:16px">
      <div class="sbar-lbl">Entity</div>
      <div class="sbar-ep ep-all"   id="sep-all"   onclick="setEnt('all',this)"><div class="edot" style="background:#8a8d96"></div>All</div>
      <div class="sbar-ep"          id="sep-orin"  onclick="setEnt('Orin Global',this)"><div class="edot" style="background:var(--accent)"></div>Orin Global</div>
      <div class="sbar-ep"          id="sep-aasha" onclick="setEnt('Aasha Setu',this)"><div class="edot" style="background:var(--accent2)"></div>Aasha Setu</div>
    </div>
    <button class="sbar-sync" onclick="goto('sheets')">üìä Sheets &amp; Drive</button>
  </aside>

  <div style="flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;">
    <!-- MOBILE TOPBAR -->
    <div class="topbar">
      <div class="topbar-logo">ExpenseFlow</div>
      <div class="topbar-entity">
        <div class="ent-pill ep-all"  id="mp-all"   onclick="setEnt('all',null)">All</div>
        <div class="ent-pill"         id="mp-orin"  onclick="setEnt('Orin Global',null)">Orin</div>
        <div class="ent-pill"         id="mp-aasha" onclick="setEnt('Aasha Setu',null)">Aasha</div>
      </div>
    </div>

    <!-- CONTENT -->
    <div class="content" id="content">

      <!-- DASHBOARD -->
      <div class="page active" id="page-dash">
        <div class="sec-title">Dashboard</div>
        <div class="sec-sub" id="dash-sub">All Entities</div>
        <div class="stat-grid">
          <div class="stat"><div class="lbl">Total Spend</div><div class="val yellow" id="s-total">‚Çπ0</div><div class="sub" id="s-cnt">0 expenses</div></div>
          <div class="stat"><div class="lbl">This Month</div><div class="val" id="s-month">‚Çπ0</div><div class="sub" id="s-mlbl"></div></div>
          <div class="stat"><div class="lbl">Receipts</div><div class="val green" id="s-rcpt">0</div><div class="sub">uploaded</div></div>
          <div class="stat"><div class="lbl">Pending Sync</div><div class="val red" id="s-pend">0</div><div class="sub">to sync</div></div>
        </div>
        <div class="chart-card"><h4>By Category</h4><div id="d-cat"></div></div>
        <div class="chart-card"><h4>By Entity</h4><div id="d-ent"></div></div>
        <div style="font-size:13px;color:var(--muted);margin-bottom:10px;font-weight:500;">Recent Entries</div>
        <div id="d-recent"></div>
      </div>

      <!-- ALL EXPENSES -->
      <div class="page" id="page-expenses">
        <div class="sec-title">All Expenses</div>
        <div class="sec-sub" id="exp-lbl">Full log</div>
        <div class="filter-bar">
          <input type="text" placeholder="Search..." id="f-search" oninput="renderExpenses()" class="fsel" style="min-width:120px;flex:1;">
          <select class="fsel" id="f-ent" onchange="renderExpenses()">
            <option value="">All Entities</option>
            <option>Orin Global</option><option>Aasha Setu</option>
          </select>
          <select class="fsel" id="f-cat" onchange="renderExpenses()">
            <option value="">All Categories</option>
            <option>Travel &amp; Transport</option>
            <option>Meals &amp; Entertainment</option>
            <option>Office &amp; Supplies</option>
            <option>Software &amp; Subscriptions</option>
            <option>Office Rent</option>
          </select>
          <select class="fsel" id="f-mon" onchange="renderExpenses()"><option value="">All Time</option></select>
        </div>
        <div id="exp-list"></div>
      </div>

      <!-- ANALYTICS -->
      <div class="page" id="page-analytics">
        <div class="sec-title">Analytics</div>
        <div class="sec-sub">Spend breakdown</div>
        <div id="an-body"></div>
      </div>

      <!-- SHEETS -->
      <div class="page" id="page-sheets">
        <div class="sec-title">Sheets &amp; Drive</div>
        <div class="sec-sub">Finance team sync</div>
        <div class="setup-block">
          <h3>Google Sheets</h3>
          <p class="sp">Paste your spreadsheet URL to connect and push all expenses.</p>
          <div class="step-row"><div class="step-num">1</div><div class="step-txt">Create a sheet <strong>"ExpenseFlow Tracker"</strong></div></div>
          <div class="step-row"><div class="step-num">2</div><div class="step-txt">Paste the <strong>Apps Script /exec URL</strong> and tap Connect</div></div>
          <div class="step-row"><div class="step-num">3</div><div class="step-txt">Tap <strong>Sync Now</strong> anytime</div></div>
          <div class="fg" style="margin-top:14px;margin-bottom:10px">
            <label>Google Sheets URL</label>
            <input type="url" id="sheets-url" placeholder="https://script.google.com/macros/s/.../exec">
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn-p" style="font-size:14px;padding:11px" onclick="connectSheets()">Connect</button>
            <button class="btn-g" style="font-size:14px;padding:11px;flex:1" onclick="syncNow()">Sync Now</button>
          </div>
          <div class="conn-bar" id="sheets-status" style="display:none"><div class="pulse"></div><span id="sheets-txt">Connected</span></div>
        </div>
        <div class="setup-block">
          <h3>Google Drive Folders</h3>
          <p class="sp">Receipts are stored per entity. Paste the Drive folder IDs below.</p>
          <div class="drive-row">
            <div class="dlbl orin">Orin Global</div>
            <input type="text" id="drive-orin" placeholder="Drive Folder ID..." class="finput">
          </div>
          <div class="drive-row">
            <div class="dlbl aasha">Aasha Setu</div>
            <input type="text" id="drive-aasha" placeholder="Drive Folder ID..." class="finput">
          </div>
          <button class="btn-p" style="font-size:14px;padding:11px;width:100%;margin-top:4px" onclick="saveDrive()">Save Folder IDs</button>
        </div>
        <div class="setup-block">
          <h3>Export</h3>
          <p class="sp">Download expense data as CSV for your accountant.</p>
          <div class="exp-btns">
            <button class="btn-g" style="font-size:13px;padding:11px" onclick="exportCSV('all')">All Expenses</button>
            <button class="btn-g" style="font-size:13px;padding:11px" onclick="exportCSV('Orin Global')">Orin Global</button>
            <button class="btn-g" style="font-size:13px;padding:11px" onclick="exportCSV('Aasha Setu')">Aasha Setu</button>
            <button class="btn-g" style="font-size:13px;padding:11px" onclick="copyJSON()">Copy JSON</button>
          </div>
        </div>
      </div>

    </div><!-- /content -->

    <button class="fab" onclick="openAdd()">+</button>

    <nav class="bottom-nav">
      <button class="bnav-btn active" id="bn-dash"      onclick="goto('dash')"><span class="bi">‚¨°</span>Dashboard</button>
      <button class="bnav-btn"        id="bn-expenses"  onclick="goto('expenses')"><span class="bi">‚óà</span>Expenses</button>
      <button class="bnav-btn"        id="bn-analytics" onclick="goto('analytics')"><span class="bi">‚óâ</span>Analytics</button>
      <button class="bnav-btn"        id="bn-sheets"    onclick="goto('sheets')"><span class="bi">‚¨¢</span>Sync</button>
    </nav>
  </div>
</div>

<!-- ADD/EDIT MODAL -->
<div class="modal-overlay" id="add-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="m-title">Add Expense</div>
    <div class="mserial" id="m-serial">SS_Exp_0001</div>
    <div class="form2">
      <div class="fg"><label>Date</label><input type="date" id="m-date"></div>
      <div class="fg"><label>Entity</label>
        <select id="m-entity" onchange="updateDNote()">
          <option value="Orin Global">Orin Global</option>
          <option value="Aasha Setu">Aasha Setu</option>
        </select>
      </div>
    </div>
    <div class="fg"><label>Description</label><input type="text" id="m-desc" placeholder="e.g. Flight to Delhi, Office Lunch..."></div>
    <div class="form2">
      <div class="fg"><label>Category</label>
        <select id="m-cat">
          <option value="Travel &amp; Transport">Travel &amp; Transport</option>
          <option value="Meals &amp; Entertainment">Meals &amp; Entertainment</option>
          <option value="Office &amp; Supplies">Office &amp; Supplies</option>
          <option value="Software &amp; Subscriptions">Software &amp; Subscriptions</option>
          <option value="Office Rent">Office Rent</option>
        </select>
      </div>
      <div class="fg"><label>Amount (‚Çπ)</label><input type="number" id="m-amount" placeholder="0" step="1" min="0" inputmode="decimal"></div>
    </div>
    <div class="fg" style="position:relative">
      <label>Paid Through ‚Äî <span style="color:var(--muted);font-weight:300">type or pick from history</span></label>
      <input type="text" id="m-paid" placeholder="e.g. HDFC Card, UPI, Petty Cash..." oninput="filterPaid()" onfocus="showPaid()" onblur="hidePaid()" autocomplete="off">
      <div class="paid-opts" id="paid-dd"></div>
    </div>
    <div class="fg"><label>Notes (optional)</label><textarea id="m-notes" placeholder="Purpose, project code, attendees..."></textarea></div>
    <div class="fg">
      <label>Receipt</label>
      <div class="upload-zone" id="upzone" onclick="document.getElementById('m-file').click()" ondragover="doDragOver(event)" ondrop="doDrop(event)" ondragleave="doDragLeave(event)">
        <div class="ui">üìé</div>
        <p><strong>Tap to upload</strong> ¬∑ PNG, JPG, PDF</p>
        <input type="file" id="m-file" accept="image/*,.pdf" onchange="fileSel(event)">
        <div class="uprev" id="m-prev"></div>
      </div>
      <div class="drive-note" id="drive-note">üìÅ Will save to ExpenseFlow / Orin Global</div>
    </div>
    <div class="mact">
      <button class="btn-g" onclick="closeModal()">Cancel</button>
      <button class="btn-p" onclick="saveExp()">Save Expense</button>
    </div>
  </div>
</div>

<!-- CONFIRM DELETE -->
<div class="modal-overlay" id="del-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="confirm-body">
      <div class="ci">üóëÔ∏è</div>
      <div class="modal-title">Delete Expense?</div>
      <p>This is permanent and cannot be undone.</p>
      <div class="mact">
        <button class="btn-g" onclick="closeDelModal()">Cancel</button>
        <button class="btn-d" onclick="doDelete()">Yes, Delete</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"><span id="t-icon">‚úì</span><span id="t-msg"></span></div>

<script>
var expenses    = JSON.parse(localStorage.getItem('ef6_exp') || 'null');
var paidMethods = JSON.parse(localStorage.getItem('ef6_paid') || '["HDFC Corporate Card","ICICI Current Account","UPI","Petty Cash","Personal Card (Reimburse)"]');
var sheetsConn  = localStorage.getItem('ef6_sc') === 'true';
var sheetsUrl   = localStorage.getItem('ef6_su') || '';
var driveFolders= JSON.parse(localStorage.getItem('ef6_df') || '{"Orin Global":"","Aasha Setu":""}');
var entFilter   = 'all';
var editingId   = null;
var delId       = null;
var selFile     = null;
var curPage     = 'dash';

function nextSerial() {
  var max = 0;
  expenses.forEach(function(e) {
    var m = e.serial && e.serial.match(/SS_Exp_(\d+)/);
    if (m) max = Math.max(max, parseInt(m[1]));
  });
  return 'SS_Exp_' + String(max + 1).padStart(4, '0');
}

if (!expenses) {
  expenses = [
    {id:1,serial:'SS_Exp_0001',date:'2026-02-20',entity:'Orin Global',desc:'Flight BOM to DEL',cat:'Travel & Transport',amount:8500,paid:'HDFC Corporate Card',notes:'Rabo Foundation meeting',receipt:'flight_receipt.pdf',synced:true},
    {id:2,serial:'SS_Exp_0002',date:'2026-02-18',entity:'Aasha Setu',desc:'Team Dinner Q1 Planning',cat:'Meals & Entertainment',amount:4200,paid:'Petty Cash',notes:'',receipt:null,synced:true},
    {id:3,serial:'SS_Exp_0003',date:'2026-02-15',entity:'Orin Global',desc:'Office Supplies Q1',cat:'Office & Supplies',amount:2350,paid:'UPI',notes:'Printer cartridges, pads',receipt:'invoice_feb.png',synced:false},
    {id:4,serial:'SS_Exp_0004',date:'2026-02-12',entity:'Aasha Setu',desc:'Feb Office Rent',cat:'Office Rent',amount:28000,paid:'ICICI Current Account',notes:'Monthly lease',receipt:null,synced:true},
    {id:5,serial:'SS_Exp_0005',date:'2026-02-10',entity:'Orin Global',desc:'Notion and Figma Annual',cat:'Software & Subscriptions',amount:1850,paid:'Personal Card (Reimburse)',notes:'',receipt:'stripe_receipt.png',synced:false}
  ];
  save();
}

function save()     { localStorage.setItem('ef6_exp', JSON.stringify(expenses)); }
function savePaid() { localStorage.setItem('ef6_paid', JSON.stringify(paidMethods)); }

function inr(n) { return '‚Çπ' + Number(n).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function todayStr() { return new Date().toISOString().slice(0,10); }
function curYM()    { var d=new Date(); return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); }

var CC = {'Travel & Transport':'#e8c97a','Meals & Entertainment':'#f87a6b','Office & Supplies':'#6ee7b7','Software & Subscriptions':'#a78bfa','Office Rent':'#38bdf8'};
var EC = {'Orin Global':'#e8c97a','Aasha Setu':'#6ee7b7'};
var CB = {'Travel & Transport':'bt','Meals & Entertainment':'bm','Office & Supplies':'bo','Software & Subscriptions':'bs','Office Rent':'br'};

function goto(name) {
  curPage = name;
  document.querySelectorAll('.page').forEach(function(p){p.classList.remove('active');});
  document.getElementById('page-'+name).classList.add('active');
  document.querySelectorAll('.bnav-btn').forEach(function(b){b.classList.remove('active');});
  var bn = document.getElementById('bn-'+name); if(bn) bn.classList.add('active');
  document.querySelectorAll('.sbar-btn').forEach(function(b){b.classList.remove('active');});
  var sb = document.getElementById('sbn-'+name); if(sb) sb.classList.add('active');
  document.getElementById('content').scrollTo(0,0);
  if(name==='dash')      renderDash();
  if(name==='expenses')  { populateMonths(); renderExpenses(); }
  if(name==='analytics') renderAnalytics();
  if(name==='sheets')    initSheets();
}

function setEnt(ent, el) {
  entFilter = ent;
  // mobile pills
  ['all','orin','aasha'].forEach(function(k){
    var p=document.getElementById('mp-'+k);
    if(p) { p.className='ent-pill'; }
  });
  var mKey = ent==='all'?'all':ent==='Orin Global'?'orin':'aasha';
  var mp=document.getElementById('mp-'+mKey);
  if(mp) mp.className='ent-pill ep-'+mKey;
  // desktop pills
  document.querySelectorAll('.sbar-ep').forEach(function(p){
    p.className='sbar-ep';
  });
  var dKey = ent==='all'?'all':ent==='Orin Global'?'orin':'aasha';
  var sep=document.getElementById('sep-'+dKey);
  if(sep) sep.className='sbar-ep ep-'+dKey;
  renderDash();
  if(curPage==='expenses') renderExpenses();
}

function filtered() { return entFilter==='all' ? expenses : expenses.filter(function(e){return e.entity===entFilter;}); }

function renderDash() {
  var data=filtered();
  var total=data.reduce(function(s,e){return s+e.amount;},0);
  var ym=curYM();
  var monthly=data.filter(function(e){return e.date.startsWith(ym);}).reduce(function(s,e){return s+e.amount;},0);
  document.getElementById('s-total').textContent = inr(total);
  document.getElementById('s-cnt').textContent   = data.length+' expense'+(data.length!==1?'s':'');
  document.getElementById('s-month').textContent = inr(monthly);
  document.getElementById('s-mlbl').textContent  = new Date().toLocaleString('default',{month:'short',year:'numeric'});
  document.getElementById('s-rcpt').textContent  = data.filter(function(e){return e.receipt;}).length;
  document.getElementById('s-pend').textContent  = data.filter(function(e){return !e.synced;}).length;
  document.getElementById('dash-sub').textContent= entFilter==='all'?'All Entities':entFilter;
  renderBars('d-cat',data,'cat',CC);
  renderBars('d-ent',data,'entity',EC);
  var recent=[].concat(data).sort(function(a,b){return b.date.localeCompare(a.date);}).slice(0,5);
  document.getElementById('d-recent').innerHTML = recent.length
    ? recent.map(function(e){return expCard(e,false);}).join('')
    : emptyState('No expenses yet','Tap + to add your first expense.');
}

function renderBars(id,data,field,colors) {
  var tot={};
  data.forEach(function(e){ tot[e[field]]=(tot[e[field]]||0)+e.amount; });
  var sorted=Object.entries(tot).sort(function(a,b){return b[1]-a[1];});
  var max=sorted[0]?sorted[0][1]:1;
  document.getElementById(id).innerHTML=sorted.map(function(kv){
    var k=kv[0],v=kv[1];
    return '<div class="bar-row"><div class="bar-lbl" title="'+k+'">'+k.replace(/&/g,'&amp;')+'</div><div class="bar-track"><div class="bar-fill" style="width:'+((v/max)*100).toFixed(1)+'%;background:'+(colors[k]||'#8a8d96')+'"></div></div><div class="bar-val">'+inr(v)+'</div></div>';
  }).join('') || '<div style="color:var(--muted);font-size:13px">No data</div>';
}

function expCard(e, showActions) {
  if(showActions===undefined) showActions=true;
  var actions='';
  if(showActions){
    var syncedClr=e.synced?'var(--accent2)':'var(--muted)';
    var syncedTxt=e.synced?'Synced':'Pending';
    actions='<div class="exp-actions"><button class="act-btn edit" onclick="openEdit('+e.id+')">‚úé Edit</button><button class="act-btn del" onclick="askDel('+e.id+')">üóë Delete</button><span class="synced-badge" style="color:'+syncedClr+'">'+syncedTxt+'</span></div>';
  }
  var notes=e.notes?'<div class="exp-notes">'+e.notes+'</div>':'';
  var rcpt=e.receipt?'<span class="exp-rcpt">üìé '+e.receipt+'</span>':'';
  var paid=e.paid?'<span class="exp-paid">üí≥ '+e.paid+'</span>':'';
  return '<div class="expense-card">'
    +'<div class="exp-top"><span class="exp-serial">'+e.serial+'</span><span class="exp-amount">'+inr(e.amount)+'</span></div>'
    +'<div class="exp-desc">'+e.desc+'</div>'
    +'<div class="exp-meta"><span class="badge '+(CB[e.cat]||'')+'">'+e.cat+'</span>'
    +'<span class="etag '+(e.entity==='Orin Global'?'orin':'aasha')+'">'+e.entity+'</span>'
    +'<span class="exp-date">'+e.date+'</span>'+paid+rcpt+'</div>'
    +notes+actions+'</div>';
}

function emptyState(title, sub) {
  return '<div class="empty-state"><div class="ei">üì≠</div><strong style="color:var(--text)">'+title+'</strong><p>'+sub+'</p></div>';
}

function populateMonths() {
  var months=[...new Set(expenses.map(function(e){return e.date.slice(0,7);}))].sort().reverse();
  document.getElementById('f-mon').innerHTML='<option value="">All Time</option>'+months.map(function(m){
    return '<option value="'+m+'">'+new Date(m+'-01').toLocaleString('default',{month:'long',year:'numeric'})+'</option>';
  }).join('');
}

function renderExpenses() {
  var q=document.getElementById('f-search').value.toLowerCase();
  var ent=document.getElementById('f-ent').value;
  var cat=document.getElementById('f-cat').value;
  var mon=document.getElementById('f-mon').value;
  var data=[].concat(expenses).sort(function(a,b){return b.serial.localeCompare(a.serial);});
  if(q)   data=data.filter(function(e){return [e.desc,e.entity,e.cat,e.paid||''].some(function(x){return x.toLowerCase().includes(q);});});
  if(ent) data=data.filter(function(e){return e.entity===ent;});
  if(cat) data=data.filter(function(e){return e.cat===cat;});
  if(mon) data=data.filter(function(e){return e.date.startsWith(mon);});
  document.getElementById('exp-lbl').textContent=data.length+' expense'+(data.length!==1?'s':'');
  document.getElementById('exp-list').innerHTML=data.length
    ? data.map(function(e){return expCard(e,true);}).join('')
    : emptyState('No results','Try adjusting your filters.');
}

function renderAnalytics() {
  var data=filtered();
  var monthly={};
  data.forEach(function(e){ var m=e.date.slice(0,7); monthly[m]=(monthly[m]||0)+e.amount; });
  var maxM=Math.max.apply(null,Object.values(monthly).concat([1]));
  var top5=[].concat(data).sort(function(a,b){return b.amount-a.amount;}).slice(0,5);
  var monthBars=Object.entries(monthly).sort().map(function(kv){
    var m=kv[0],v=kv[1];
    return '<div class="bar-row"><div class="bar-lbl">'+new Date(m+'-01').toLocaleString('default',{month:'short',year:'2-digit'})+'</div><div class="bar-track"><div class="bar-fill" style="width:'+((v/maxM)*100).toFixed(1)+'%;background:#e8c97a"></div></div><div class="bar-val">'+inr(v)+'</div></div>';
  }).join('') || '<div style="color:var(--muted);font-size:13px">No data</div>';
  var t5html=top5.map(function(e){
    return '<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:12px"><div><div style="font-size:13px;font-weight:500">'+e.desc+'</div><div style="font-size:11px;color:var(--muted)">'+e.serial+' ¬∑ '+e.entity+' ¬∑ '+e.date+'</div></div><div style="font-family:Space Mono,monospace;font-size:13px;font-weight:700;white-space:nowrap">'+inr(e.amount)+'</div></div>';
  }).join('') || '<div style="color:var(--muted);font-size:13px">No data</div>';
  document.getElementById('an-body').innerHTML=
    '<div class="chart-card"><h4>Monthly Spend</h4>'+monthBars+'</div>'
    +'<div class="chart-card"><h4>By Category</h4><div id="an-cat"></div></div>'
    +'<div class="chart-card"><h4>By Entity</h4><div id="an-ent"></div></div>'
    +'<div class="chart-card"><h4>Top 5 Expenses</h4>'+t5html+'</div>';
  renderBars('an-cat',data,'cat',CC);
  renderBars('an-ent',data,'entity',EC);
}

// MODAL
function openAdd() {
  editingId=null; selFile=null;
  document.getElementById('m-title').textContent = 'Add Expense';
  document.getElementById('m-serial').textContent = nextSerial()+' (auto-assigned)';
  document.getElementById('m-date').value   = todayStr();
  document.getElementById('m-entity').value = 'Orin Global';
  document.getElementById('m-desc').value   = '';
  document.getElementById('m-cat').value    = 'Travel & Transport';
  document.getElementById('m-amount').value = '';
  document.getElementById('m-paid').value   = '';
  document.getElementById('m-notes').value  = '';
  document.getElementById('m-prev').textContent = '';
  document.getElementById('m-file').value   = '';
  updateDNote();
  document.getElementById('add-modal').classList.add('open');
}

function openEdit(id) {
  var e=expenses.find(function(x){return x.id===id;});
  if(!e) return;
  editingId=id; selFile=null;
  document.getElementById('m-title').textContent = 'Edit Expense';
  document.getElementById('m-serial').textContent = e.serial+' (read-only)';
  document.getElementById('m-date').value   = e.date;
  document.getElementById('m-entity').value = e.entity;
  document.getElementById('m-desc').value   = e.desc;
  document.getElementById('m-cat').value    = e.cat;
  document.getElementById('m-amount').value = e.amount;
  document.getElementById('m-paid').value   = e.paid||'';
  document.getElementById('m-notes').value  = e.notes||'';
  document.getElementById('m-prev').textContent = e.receipt ? 'üìé '+e.receipt : '';
  document.getElementById('m-file').value   = '';
  updateDNote();
  document.getElementById('add-modal').classList.add('open');
}

function closeModal() { document.getElementById('add-modal').classList.remove('open'); editingId=null; selFile=null; }
document.getElementById('add-modal').addEventListener('click',function(ev){if(ev.target===ev.currentTarget)closeModal();});

function saveExp() {
  var desc   = document.getElementById('m-desc').value.trim();
  var amount = parseFloat(document.getElementById('m-amount').value);
  var paid   = document.getElementById('m-paid').value.trim();
  if(!desc)              { showToast('Please add a description','!','error'); return; }
  if(!amount||amount<=0) { showToast('Please enter a valid amount','!','error'); return; }
  if(paid && paidMethods.indexOf(paid)===-1) { paidMethods.unshift(paid); if(paidMethods.length>40)paidMethods.pop(); savePaid(); }
  var cat = document.getElementById('m-cat').value;
  var ent = document.getElementById('m-entity').value;
  var dt  = document.getElementById('m-date').value;
  var notes = document.getElementById('m-notes').value.trim();
  if(editingId) {
    var i=expenses.findIndex(function(e){return e.id===editingId;});
    if(i>=0){
      expenses[i]=Object.assign({},expenses[i],{date:dt,entity:ent,desc:desc,cat:cat,amount:amount,paid:paid,notes:notes,receipt:selFile?selFile.name:expenses[i].receipt,synced:false});
      showToast('Expense updated','‚úì','success');
    }
  } else {
    var serial=nextSerial();
    expenses.unshift({id:Date.now(),serial:serial,date:dt,entity:ent,desc:desc,cat:cat,amount:amount,paid:paid,notes:notes,receipt:selFile?selFile.name:null,synced:false});
    showToast(serial+' saved!','‚úì','success');
  }
  save(); closeModal(); populateMonths(); renderDash();
  if(curPage==='expenses') renderExpenses();
  if(curPage==='analytics') renderAnalytics();
}

function updateDNote() {
  var ent=document.getElementById('m-entity').value;
  document.getElementById('drive-note').innerHTML='üìÅ Will save to <strong>ExpenseFlow / '+ent+'</strong>';
}

// DELETE
function askDel(id)  { delId=id; document.getElementById('del-modal').classList.add('open'); }
function closeDelModal() { document.getElementById('del-modal').classList.remove('open'); delId=null; }
function doDelete() {
  expenses=expenses.filter(function(e){return e.id!==delId;});
  save(); closeDelModal(); renderDash();
  if(curPage==='expenses') renderExpenses();
  if(curPage==='analytics') renderAnalytics();
  showToast('Deleted','‚úï','error');
}
document.getElementById('del-modal').addEventListener('click',function(ev){if(ev.target===ev.currentTarget)closeDelModal();});

// PAID DROPDOWN
function showPaid()   { renderPaid(document.getElementById('m-paid').value.toLowerCase()); }
function filterPaid() { renderPaid(document.getElementById('m-paid').value.toLowerCase()); }
function renderPaid(q) {
  var dd=document.getElementById('paid-dd');
  var list=paidMethods.filter(function(m){return m.toLowerCase().includes(q);});
  if(!list.length){ dd.style.display='none'; return; }
  dd.style.display='block';
  dd.innerHTML=list.map(function(m){return '<div class="paid-opt" onmousedown="pickPaid(\''+m.replace(/'/g,"\\'")+'\')">'+m+'</div>';}).join('');
}
function pickPaid(v) { document.getElementById('m-paid').value=v; document.getElementById('paid-dd').style.display='none'; }
function hidePaid()  { setTimeout(function(){document.getElementById('paid-dd').style.display='none';},150); }

// FILE
function fileSel(ev) { var f=ev.target.files[0]; if(f){selFile=f; document.getElementById('m-prev').textContent='üìé '+f.name;} }
function doDragOver(ev) { ev.preventDefault(); document.getElementById('upzone').classList.add('dragover'); }
function doDragLeave()  { document.getElementById('upzone').classList.remove('dragover'); }
function doDrop(ev) {
  ev.preventDefault(); document.getElementById('upzone').classList.remove('dragover');
  var f=ev.dataTransfer.files[0]; if(f){selFile=f; document.getElementById('m-prev').textContent='üìé '+f.name;}
}

// SHEETS
function initSheets() {
  if(sheetsConn){ document.getElementById('sheets-status').style.display='flex'; document.getElementById('sheets-url').value=sheetsUrl; }
  document.getElementById('drive-orin').value  = driveFolders['Orin Global']||'';
  document.getElementById('drive-aasha').value = driveFolders['Aasha Setu']||'';
}
function connectSheets() {
  var url=document.getElementById('sheets-url').value.trim();
  if(!url.includes('script.google.com/macros') || !url.includes('/exec')){ showToast('Please paste your Apps Script /exec URL','!','error'); return; }
  sheetsConn=true; sheetsUrl=url;
  localStorage.setItem('ef6_sc','true'); localStorage.setItem('ef6_su',url);
  document.getElementById('sheets-status').style.display='flex';
  document.getElementById('sheets-txt').textContent='Connected ¬∑ Ready to sync';
  showToast('Connected!','‚úì','success');
}
function syncNow() {
  if(!sheetsConn){ showToast('Connect Sheets first','!','error'); return; }
  showToast('Syncing‚Ä¶','‚è≥','success');
  document.getElementById('sheets-txt').textContent='Syncing‚Ä¶';
  fetch(sheetsUrl, {
    method:'POST',
    body: JSON.stringify({ expenses: expenses }),
    headers: { 'Content-Type': 'text/plain' }
  })
  .then(function(r){ return r.json(); })
  .then(function(res){
    if(res.success){
      expenses = expenses.map(function(e){ return Object.assign({},e,{synced:true}); });
      save(); renderDash();
      if(curPage==='expenses') renderExpenses();
      var t = new Date().toLocaleTimeString();
      document.getElementById('sheets-txt').textContent='Synced '+res.count+' rows at '+t;
      showToast('Synced '+res.count+' expenses to Google Sheets ‚úì','‚úì','success');
    } else {
      showToast('Sync failed: '+res.error,'!','error');
      document.getElementById('sheets-txt').textContent='Sync failed ‚Äî check console';
    }
  })
  .catch(function(err){
    showToast('Network error ‚Äî check your URL','!','error');
    document.getElementById('sheets-txt').textContent='Connection error';
    console.error('Sync error:',err);
  });
}
function saveDrive() {
  driveFolders['Orin Global']  = document.getElementById('drive-orin').value.trim();
  driveFolders['Aasha Setu'] = document.getElementById('drive-aasha').value.trim();
  localStorage.setItem('ef6_df',JSON.stringify(driveFolders));
  showToast('Drive folder IDs saved','‚úì','success');
}
function buildCSV(data) {
  var h=['Serial No','Date','Entity','Description','Category','Amount (INR)','Paid Through','Notes','Receipt','Drive Folder','Synced'];
  var r=data.map(function(e){return [e.serial,e.date,e.entity,'"'+e.desc+'"',e.cat,e.amount,'"'+(e.paid||'')+'"','"'+(e.notes||'')+'"',e.receipt||'','"ExpenseFlow / '+e.entity+'"',e.synced?'Yes':'No'];});
  return [h].concat(r).map(function(row){return row.join(',');}).join('\n');
}
function exportCSV(ent) {
  var data=ent==='all'?expenses:expenses.filter(function(e){return e.entity===ent;});
  var a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(buildCSV(data));
  a.download=ent==='all'?'ExpenseFlow_All.csv':'ExpenseFlow_'+ent.replace(' ','_')+'.csv';
  a.click(); showToast('CSV downloaded','‚úì','success');
}
function copyJSON() { navigator.clipboard.writeText(JSON.stringify(expenses,null,2)).then(function(){showToast('JSON copied!','‚úì','success');}); }

function showToast(msg,icon,type) {
  icon=icon||'‚úì'; type=type||'success';
  var t=document.getElementById('toast');
  document.getElementById('t-msg').textContent=msg;
  document.getElementById('t-icon').textContent=icon;
  t.className='toast '+type+' show';
  clearTimeout(t._t); t._t=setTimeout(function(){t.classList.remove('show');},3000);
}

// INIT
renderDash();
populateMonths();
</script>
</body>
</html>
